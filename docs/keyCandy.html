<!DOCTYPE html>  <html> <head>   <title>keyCandy.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="keyCandy.html">                 keyCandy.js               </a>                                           <a class="source" href="keyCandy.standalone.html">                 keyCandy.standalone.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               keyCandy.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>(c) 2011 Aaron McCall.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Contributors: Beau Sorenson</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p><a href="http://creativecommons.org/licenses/MIT/">MIT license</a>.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Key Candy makes your web app melt in your hands not on your mouse!
Provides tooltips for elements with accesskey attributes and focuses/activates
elements with an accesskey in a standardized, cross-browser, cross-platform way.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">KeyCandy</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">$</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">agent</span> <span class="o">=</span> <span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">,</span>
    <span class="nx">os</span> <span class="o">=</span> <span class="sr">/Linux|Windows|Macintosh/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">agent</span><span class="p">).</span><span class="nx">toString</span><span class="p">().</span><span class="nx">toLowerCase</span><span class="p">(),</span>
    <span class="nx">browser</span> <span class="o">=</span> <span class="p">(</span><span class="nx">agent</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;WebKit&#39;</span><span class="p">)</span><span class="o">&gt;-</span><span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;webkit&#39;</span> <span class="o">:</span> <span class="sr">/Gecko|MSIE|Opera/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">agent</span><span class="p">).</span><span class="nx">toString</span><span class="p">().</span><span class="nx">toLowerCase</span><span class="p">(),</span>
    <span class="nx">os_browser_map</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">macintosh</span><span class="o">:</span> <span class="mi">91</span><span class="p">,</span> <span class="nx">linux</span><span class="o">:</span> <span class="mi">17</span><span class="p">,</span> <span class="nx">windows</span><span class="o">:</span> <span class="mi">17</span> <span class="p">},</span>
    <span class="nx">target</span><span class="p">,</span>
    <span class="nx">_class</span> <span class="o">=</span> <span class="s1">&#39;keycandy&#39;</span><span class="p">,</span>
    <span class="nx">_remove_class</span> <span class="o">=</span> <span class="s1">&#39;removeClass&#39;</span><span class="p">,</span>
    <span class="nx">_default_parent</span> <span class="o">=</span> <span class="s1">&#39;body&#39;</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Set accesskey tooltip control key to default for OS: CTRL for Windows and Linux and ⌘ for Mac Os</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">_control_key</span> <span class="o">=</span> <span class="p">(</span><span class="nx">os_browser_map</span><span class="p">[</span><span class="nx">os</span><span class="p">])</span> <span class="o">?</span> <span class="nx">os_browser_map</span><span class="p">[</span><span class="nx">os</span><span class="p">]</span> <span class="o">:</span> <span class="mi">17</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Don't require the control key to activate the accesskey'd elements</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">_req_control_key</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">_valid_mod_keys</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;⇧&#39;</span><span class="o">:</span> <span class="mi">16</span><span class="p">,</span> <span class="nx">shift</span><span class="o">:</span> <span class="mi">16</span><span class="p">,</span> <span class="nx">option</span><span class="o">:</span> <span class="mi">18</span><span class="p">,</span> <span class="s1">&#39;⌥&#39;</span><span class="o">:</span> <span class="mi">18</span><span class="p">,</span> <span class="nx">alt</span><span class="o">:</span> <span class="mi">18</span><span class="p">,</span> <span class="nx">ctrl</span><span class="o">:</span> <span class="mi">17</span><span class="p">,</span> <span class="nx">control</span><span class="o">:</span> <span class="mi">17</span><span class="p">,</span> <span class="nx">command</span><span class="o">:</span> <span class="mi">91</span><span class="p">,</span> <span class="s1">&#39;⌘&#39;</span><span class="o">:</span> <span class="mi">91</span> <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Set modifier key that allows activating accesskey'd elements while a 'typeable' element has focus</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">_mod_key</span> <span class="o">=</span> <span class="s1">&#39;alt&#39;</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Store active modifier keys here</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">_active_mods</span> <span class="o">=</span> <span class="p">{</span><span class="mi">16</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="mi">17</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="mi">18</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="mi">91</span><span class="o">:</span> <span class="kc">false</span> <span class="p">},</span>
    <span class="nx">attr_key_map</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;windows&#39;</span><span class="o">:</span> <span class="s1">&#39;ctrl&#39;</span><span class="p">,</span> <span class="s1">&#39;linux&#39;</span><span class="o">:</span> <span class="s1">&#39;ctrl&#39;</span><span class="p">,</span> <span class="s1">&#39;macintosh&#39;</span><span class="o">:</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="s1">&#39;2318&#39;</span><span class="p">,</span><span class="mi">16</span><span class="p">))},</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Handler for keydown events: sets active modifier keys and triggers appropriate events for accesskey'd elements</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">handle_keydown</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">$class_target</span> <span class="o">=</span> <span class="p">(</span><span class="nx">_target</span><span class="p">)</span> <span class="o">?</span> <span class="nx">$</span><span class="p">(</span><span class="nx">_target</span><span class="p">)</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="nx">_default_parent</span><span class="p">),</span>
            <span class="nx">_target</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">,</span>
            <span class="nx">_tag</span> <span class="o">=</span> <span class="nx">_target</span><span class="p">.</span><span class="nx">tagName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">(),</span>
            <span class="nx">$target</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">_target</span><span class="p">),</span>
            <span class="nx">_code</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">keyCode</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Is this a keydown that we may need to handle?</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">_accesskey_event</span> <span class="o">=</span> <span class="p">(</span><span class="nx">_active_mods</span><span class="p">[</span><span class="nx">_control_key</span><span class="p">]</span><span class="o">||!</span><span class="nx">_req_control_key</span><span class="p">),</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Is the current key code a valid accesskey value?</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">_valid_accesskey_code</span> <span class="o">=</span> <span class="p">(</span><span class="nx">_code</span> <span class="o">&gt;</span> <span class="mi">47</span> <span class="o">&amp;&amp;</span> <span class="nx">_code</span> <span class="o">&lt;</span> <span class="mi">58</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">_code</span> <span class="o">&gt;</span> <span class="mi">64</span> <span class="o">&amp;&amp;</span> <span class="nx">_code</span> <span class="o">&lt;</span> <span class="mi">91</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">_code</span> <span class="o">&gt;</span> <span class="mi">96</span> <span class="o">&amp;&amp;</span> <span class="nx">_code</span> <span class="o">&lt;</span> <span class="mi">123</span><span class="p">),</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>If it is, build a selector to retrieve the accesskey'd element.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">_selector</span> <span class="o">=</span> <span class="p">(</span><span class="nx">_valid_accesskey_code</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;[accesskey=&quot;&#39;</span> <span class="o">+</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">_code</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;]&#39;</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nx">$el</span> <span class="o">=</span> <span class="p">(</span><span class="nx">_selector</span><span class="p">)</span> <span class="o">?</span> <span class="nx">$</span><span class="p">(</span><span class="nx">_selector</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nx">_old_idx</span><span class="p">,</span>
            <span class="nx">_typeable</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>A smart link clicker</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">_click_link</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">link</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">cancelled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createEvent</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">event</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createEvent</span><span class="p">(</span><span class="s2">&quot;MouseEvents&quot;</span><span class="p">);</span>
                    <span class="nx">event</span><span class="p">.</span><span class="nx">initMouseEvent</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="o">!</span><span class="mi">0</span><span class="p">,</span> <span class="o">!</span><span class="mi">0</span><span class="p">,</span> <span class="nb">window</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">!</span><span class="mi">1</span><span class="p">,</span> <span class="o">!</span><span class="mi">1</span><span class="p">,</span> <span class="o">!</span><span class="mi">1</span><span class="p">,</span> <span class="o">!</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
                    <span class="nx">cancelled</span> <span class="o">=</span> <span class="o">!</span><span class="nx">link</span><span class="p">.</span><span class="nx">dispatchEvent</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">link</span><span class="p">.</span><span class="nx">fireEvent</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">cancelled</span> <span class="o">=</span> <span class="o">!</span><span class="nx">link</span><span class="p">.</span><span class="nx">fireEvent</span><span class="p">(</span><span class="s2">&quot;onclick&quot;</span><span class="p">);</span>
                <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>If no event handler has prevented default link click behavior, navigate to the href.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">cancelled</span> <span class="o">&amp;&amp;</span> <span class="nx">link</span><span class="p">.</span><span class="nx">href</span><span class="p">)</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="nx">link</span><span class="p">.</span><span class="nx">href</span><span class="p">;</span>
            <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Normalize right and left ⌘ keys on Mac Os</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">_code</span> <span class="o">==</span> <span class="mi">93</span> <span class="o">||</span> <span class="nx">_code</span> <span class="o">==</span> <span class="mi">224</span><span class="p">)</span> <span class="nx">_code</span> <span class="o">=</span> <span class="mi">91</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Workaround for Opera Mac's insane handling of the ⌘ key</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">_code</span> <span class="o">==</span> <span class="mi">17</span> <span class="o">&amp;&amp;</span> <span class="nb">window</span><span class="p">.</span><span class="nx">opera</span> <span class="o">&amp;&amp;</span> <span class="nx">_control_key</span> <span class="o">==</span> <span class="mi">91</span> <span class="o">&amp;&amp;</span> <span class="nx">event</span><span class="p">.</span><span class="nx">ctrlKey</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="nx">_code</span> <span class="o">=</span> <span class="mi">91</span><span class="p">;</span>
        </pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>If the current key code is a modifier key, set it active.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">_active_mods</span><span class="p">[</span><span class="nx">_code</span><span class="p">]</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">_active_mods</span><span class="p">[</span><span class="nx">_code</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Are we supposed to be typing write now? Meaning: Does a typeable element
have focus and is the modifier key not pressed?</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">_typeable</span> <span class="o">=</span> <span class="p">(</span><span class="sr">/^(sel|tex)/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">_tag</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">_tag</span> <span class="o">===</span> <span class="s1">&#39;input&#39;</span>
                  <span class="o">&amp;&amp;</span> <span class="sr">/^(tex|pas|ema|sea|tel|url|dat)/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">_target</span><span class="p">.</span><span class="nx">type</span><span class="p">)))</span>
                  <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">_active_mods</span><span class="p">[</span><span class="nx">_valid_mod_keys</span><span class="p">[</span><span class="nx">_mod_key</span><span class="p">]];</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>If the current key is the tooltip control key, toggle the tooltip revealing class.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">_code</span> <span class="o">===</span> <span class="nx">_control_key</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">_typeable</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">$class_target</span><span class="p">.</span><span class="nx">toggleClass</span><span class="p">(</span><span class="nx">_class</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">_accesskey_event</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">_typeable</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">_valid_accesskey_code</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">$el</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Let's activate an accesskey'd element!</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="nx">$el</span> <span class="o">=</span> <span class="p">(</span><span class="nx">$el</span><span class="p">.</span><span class="nx">is</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">))</span> <span class="o">?</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="nx">$el</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;for&#39;</span><span class="p">))</span> <span class="o">:</span> <span class="nx">$el</span><span class="p">;</span>
                        <span class="kd">var</span> <span class="nx">el</span> <span class="o">=</span> <span class="nx">$el</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">el_tag</span> <span class="o">=</span> <span class="nx">el</span><span class="p">.</span><span class="nx">tagName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
                        <span class="kd">var</span> <span class="nx">_action</span> <span class="o">=</span> <span class="nx">$el</span><span class="p">.</span><span class="nx">is</span><span class="p">(</span><span class="s1">&#39;:text, :password, textarea, select&#39;</span><span class="p">)</span><span class="o">?</span><span class="s1">&#39;focus&#39;</span><span class="o">:</span><span class="s1">&#39;click&#39;</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">el_tag</span> <span class="o">==</span> <span class="s1">&#39;a&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">el</span><span class="p">.</span><span class="nx">href</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">_click_link</span><span class="p">(</span><span class="nx">el</span><span class="p">);</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">el_tag</span> <span class="o">==</span> <span class="s1">&#39;select&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">browser</span><span class="o">==</span><span class="s1">&#39;gecko&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">_tag</span><span class="o">!=</span><span class="s1">&#39;select&#39;</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Gecko does some really crazy stuff with keydown bleeding through all attempts to prevent keypress.
So we are going to get the selectedIndex and set it back as soon as the event finishes.  </p>             </td>             <td class="code">               <div class="highlight"><pre>                            <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">_idx</span><span class="p">){</span>
                                <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span> <span class="nx">el</span><span class="p">.</span><span class="nx">selectedIndex</span><span class="o">=</span><span class="nx">_idx</span><span class="p">;</span> <span class="p">},</span> <span class="mi">0</span><span class="p">);</span>
                            <span class="p">})(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">el</span><span class="p">.</span><span class="nx">selectedIndex</span><span class="p">);</span>
                        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Don't type the character if we are in a typeable element and don't bubble up the DOM.</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="nx">event</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">();</span>
                        <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Focus or click the element depending on what is appropriate.</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="nx">$el</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">_action</span><span class="p">);</span>

                    <span class="p">}</span>
                <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Remove the tooltip revealer class</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">$class_target</span><span class="p">[</span><span class="nx">_remove_class</span><span class="p">](</span><span class="nx">_class</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Keyup handler that clears modifier keys from active modifiers.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">unset_modkey</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">_code</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">keyCode</span><span class="p">;</span><span class="k">if</span> <span class="p">(</span><span class="nx">_code</span> <span class="o">==</span> <span class="mi">93</span> <span class="o">||</span> <span class="nx">_code</span> <span class="o">==</span> <span class="mi">224</span><span class="p">)</span> <span class="nx">_code</span> <span class="o">=</span> <span class="mi">91</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">opera</span> <span class="o">&amp;&amp;</span> <span class="nx">_code</span> <span class="o">==</span> <span class="mi">17</span> <span class="o">&amp;&amp;</span> <span class="nx">event</span><span class="p">.</span><span class="nx">ctrlKey</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="nx">_code</span> <span class="o">=</span> <span class="mi">91</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>IF this is a modifier key, clear it from active modifiers.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">_code</span> <span class="k">in</span> <span class="nx">_active_mods</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">_active_mods</span><span class="p">[</span><span class="nx">_code</span><span class="p">]</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="nx">version</span><span class="o">:</span> <span class="s1">&#39;1.0RC&#39;</span><span class="p">,</span>
        <span class="nx">init</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">opt</span><span class="p">){</span>
            <span class="nx">opt</span> <span class="o">||</span> <span class="p">(</span><span class="nx">opt</span> <span class="o">=</span> <span class="p">{});</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Set options</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">opt</span><span class="p">.</span><span class="nx">ctrlKey</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">_control_key</span> <span class="o">=</span> <span class="nx">opt</span><span class="p">.</span><span class="nx">ctrlKey</span><span class="p">);</span>
            <span class="nx">opt</span><span class="p">.</span><span class="nx">reqCtrlKey</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">_req_control_key</span> <span class="o">=</span> <span class="nx">opt</span><span class="p">.</span><span class="nx">reqCtrlKey</span><span class="p">);</span>
            <span class="nx">opt</span><span class="p">.</span><span class="nx">modKey</span> <span class="o">&amp;&amp;</span> <span class="nx">_valid_mod_keys</span><span class="p">[</span><span class="nx">opt</span><span class="p">.</span><span class="nx">modKey</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">_mod_key</span> <span class="o">=</span> <span class="nx">opt</span><span class="p">.</span><span class="nx">modKey</span><span class="p">);</span>
            <span class="nx">target</span> <span class="o">=</span> <span class="nx">opt</span><span class="p">.</span><span class="nx">parent</span> <span class="o">||</span> <span class="nx">_default_parent</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Setup event handlers for key events.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">$</span><span class="p">(</span><span class="nx">browser</span><span class="o">==</span><span class="s1">&#39;msie&#39;</span> <span class="o">?</span> <span class="nb">document</span> <span class="o">:</span> <span class="nb">window</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;keydown&#39;</span><span class="p">,</span> <span class="nx">handle_keydown</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;keyup&#39;</span><span class="p">,</span> <span class="nx">unset_modkey</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Add a click handler on the class target to clear tooltips.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">$</span><span class="p">(</span><span class="nx">target</span><span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">)[</span><span class="nx">_remove_class</span><span class="p">](</span><span class="nx">_class</span><span class="p">);</span> <span class="p">})</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Add hint text to the data attribute of our class target.</p>             </td>             <td class="code">               <div class="highlight"><pre>                     <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;data-kchint&#39;</span><span class="p">,</span> <span class="s1">&#39;Press [&#39;</span> <span class="o">+</span> <span class="nx">attr_key_map</span><span class="p">[</span><span class="nx">os</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;] to hide tooltips.&#39;</span><span class="p">);</span>
        <span class="p">},</span>
        <span class="nx">os</span><span class="o">:</span> <span class="nx">os</span><span class="p">,</span>
        <span class="nx">browser</span><span class="o">:</span> <span class="nx">browser</span>
    <span class="p">};</span>
<span class="p">})(</span><span class="nb">window</span><span class="p">.</span><span class="nx">jQuery</span><span class="p">);</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 